-- Q1: Revenue per sales channel in 2021
SELECT sales_channel, SUM(amount) AS total_revenue
FROM clinic_sales
WHERE strftime('%Y', datetime) = '2021'
GROUP BY sales_channel;

-- Q2: Top 10 most valuable customers in 2021
SELECT c.uid, c.name, SUM(cs.amount) AS total_spent
FROM customer c
JOIN clinic_sales cs ON c.uid = cs.uid
WHERE strftime('%Y', cs.datetime) = '2021'
GROUP BY c.uid, c.name
ORDER BY total_spent DESC
LIMIT 10;

-- Q3: Month-wise revenue, expense, profit, status
WITH revenue AS (
    SELECT strftime('%Y-%m', datetime) AS month, SUM(amount) AS total_revenue
    FROM clinic_sales
    WHERE strftime('%Y', datetime) = '2021'
    GROUP BY month
),
expense AS (
    SELECT strftime('%Y-%m', datetime) AS month, SUM(amount) AS total_expense
    FROM expenses
    WHERE strftime('%Y', datetime) = '2021'
    GROUP BY month
)
SELECT r.month, r.total_revenue, IFNULL(e.total_expense,0) AS total_expense,
       r.total_revenue - IFNULL(e.total_expense,0) AS profit,
       CASE WHEN r.total_revenue - IFNULL(e.total_expense,0) >= 0 THEN 'Profitable'
            ELSE 'Not Profitable'
       END AS status
FROM revenue r
LEFT JOIN expense e ON r.month = e.month
ORDER BY r.month;

-- Q4: Most profitable clinic per city for Sep 2021
WITH clinic_profit AS (
    SELECT c.cid, c.clinic_name, c.city,
           SUM(cs.amount) - IFNULL(SUM(e.amount),0) AS profit
    FROM clinics c
    LEFT JOIN clinic_sales cs ON c.cid = cs.cid AND strftime('%Y-%m', cs.datetime) = '2021-09'
    LEFT JOIN expenses e ON c.cid = e.cid AND strftime('%Y-%m', e.datetime) = '2021-09'
    GROUP BY c.cid
),
ranked_clinics AS (
    SELECT *, RANK() OVER (PARTITION BY city ORDER BY profit DESC) AS rnk
    FROM clinic_profit
)
SELECT city, clinic_name, profit
FROM ranked_clinics
WHERE rnk = 1;

-- Q5: Second least profitable clinic per state for Sep 2021
WITH clinic_profit AS (
    SELECT c.cid, c.clinic_name, c.state,
           SUM(cs.amount) - IFNULL(SUM(e.amount),0) AS profit
    FROM clinics c
    LEFT JOIN clinic_sales cs ON c.cid = cs.cid AND strftime('%Y-%m', cs.datetime) = '2021-09'
    LEFT JOIN expenses e ON c.cid = e.cid AND strftime('%Y-%m', e.datetime) = '2021-09'
    GROUP BY c.cid
),
ranked_clinics AS (
    SELECT *, RANK() OVER (PARTITION BY state ORDER BY profit ASC) AS rnk
    FROM clinic_profit
)
SELECT state, clinic_name, profit
FROM ranked_clinics
WHERE rnk = 2;
